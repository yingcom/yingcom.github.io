{"componentChunkName":"component---src-templates-blog-post-js","path":"/post/2021-04-02/gatsby-plugins-versioning-and-build-failure/","result":{"data":{"site":{"siteMetadata":{"title":"Ying Feng Official Website"}},"current":{"excerpt":"CSS Plugins and Build Failure There are different options for styling website in Gatsby. Global CSS CSS modules (built-in support in Gatsby) CSS-in-JS (pluginsâ€¦","html":"<h1>CSS Plugins and Build Failure</h1>\n<p>There are different options for styling website in Gatsby.</p>\n<ol>\n<li>Global CSS</li>\n<li>CSS modules (built-in support in Gatsby)</li>\n<li>CSS-in-JS (plugins required)</li>\n<li>SASS/SCSS (plugins required)</li>\n</ol>\n<p>I don't like mixing CSS with markup or any unnecessary inline CSS, so CSS-in-JS is dropped. SASS/SCSS requires extra plugins and it would be an overkill for a small website. I use CSS modules and global CSS for this blog, because Gatsby has built-in support for CSS modules and no extra config is required. At the final phase of development of this site, it suddenly dawned on me that I needed PostCSS for browser compatibility, which I forgot to install from the beginning. So I installed the packages</p>\n<pre class=\"grvsc-container monokai grvsc-ps-tsSx3w grvsc-mm-tiaGIi grvsc-ps-tiaGIi solarized-light\" data-language=\"sh\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">npm install postcss gatsby-plugin-postcss postcss-preset-env --save-dev</span></span></span></code></pre>\n<p>and adjust the plugins configurations in <code class=\"grvsc-inline-code solarized-light\" data-language=\"md\" data-index=\"0\"><span class=\"mtk1\">gatsby-config.js</span></code> according to the documentation.</p>\n<pre class=\"grvsc-container monokai grvsc-ps-tsSx3w grvsc-mm-tiaGIi grvsc-ps-tiaGIi\" data-language=\"js\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-tsSx3w-1 mtk1\">  plugins: [</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-tsSx3w-1 mtk1\">    {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-tsSx3w-1 mtk1\">      resolve: </span><span class=\"grvsc-tsSx3w-6 grvsc-tiaGIi-11\">&quot;gatsby-plugin-postcss&quot;</span><span class=\"grvsc-tsSx3w-1 mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-tsSx3w-1 mtk1\">      options: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-tsSx3w-1 mtk1\">        postCssPlugins: [</span><span class=\"grvsc-tsSx3w-9 grvsc-tiaGIi-7\">require</span><span class=\"grvsc-tsSx3w-1 mtk1\">(</span><span class=\"grvsc-tsSx3w-6 grvsc-tiaGIi-11\">`postcss-preset-env`</span><span class=\"grvsc-tsSx3w-1 mtk1\">)({ stage: </span><span class=\"grvsc-tsSx3w-4 grvsc-tiaGIi-6\">0</span><span class=\"grvsc-tsSx3w-1 mtk1\"> })],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-tsSx3w-1 mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-tsSx3w-1 mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-tsSx3w-1 mtk1\">  }</span></span></span></code></pre>\n<p>However, it broke the development server with many error messages similar to the following:</p>\n<pre class=\"grvsc-container monokai grvsc-ps-tsSx3w grvsc-mm-tiaGIi grvsc-ps-tiaGIi\" data-language=\"\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">ERROR #98123  WEBPACK</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Generating development JavaScript bundle failed</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Style Loader Invalid Options</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">options should NOT have additional properties</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">File: src/components/navigation.module.css</span></span></code></pre>\n<p>Somehow the stylesheets using CSS modules ([filename].module.css) were not loaded by Webpack, while the global stylesheet ([filename].css) had no such problem.</p>\n<h1>Versioning Problem</h1>\n<p>Gatsby v3 was just released when I installed the gatsby-plugin-postcss plugin. There were lots of <a href=\"https://www.gatsbyjs.com/docs/reference/release-notes/migrating-from-v2-to-v3/#handling-breaking-changes\">breaking changes</a> between Gatsby v2 and v3. Webpack and CSS Modules were on the list. At first I thought the build failure was caused by misconfigurations of CSS loaders in Webpack.</p>\n<p>However, after turning off gatsby-plugin-postcss@^4.1.0 in Gatsby v2, the build process went back to normal. It seems the problem came from the plugin itself. According to the <a href=\"https://github.com/gatsbyjs/gatsby/blob/master/packages/gatsby-plugin-postcss/CHANGELOG.md\">changelog of gatsby-plugin-postcss</a>, there was a version mismatch between the plugin and Gatsby, which could cause the build to fail.</p>\n<blockquote>\n<p>gatsby-plugin-postcss@^3.6 is compatible with gatsby@^2.32<br>\ngatsby-plugin-postcss@^4.1 is compatible with gatsby@^3.2</p>\n</blockquote>\n<p>This website was initially developed in Gatsby v2. If I rolled backed to gatsby-plugin-postcss@^3.6.0 with Gatsby v2, the build didn't fail with the gatsby-plugin-postcss enabled this time. A more future-proofing solution is migrating to Gatsby v3 and <a href=\"https://www.gatsbyjs.com/docs/reference/release-notes/migrating-from-v2-to-v3/#css-modules-are-imported-as-es-modules\">rewriting the import syntax for CSS modules</a>.</p>\n<p>A build failure due to version mismatch is common in software development. However, trouble shooting becomes somewhat annoying when the official plugins compatibility with different versions of Gatsby is not documented clearly. Debugging errors thrown by Webpack in Gatsby is not pleasant. Gatsby uses Webpack under the hood, but the Webpack config file is not exposed at the top level. You need to check the Webpack config in Gatsby's source codes on GitHub, and if necessary, overwrite it in your local <code class=\"grvsc-inline-code solarized-light\" data-language=\"md\" data-index=\"1\"><span class=\"mtk1\">gatsby-node.js</span></code> file.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .monokai {\n    background-color: #272822;\n    color: #f8f8f2;\n  }\n  .monokai .grvsc-tsSx3w-1 { color: #F8F8F2; }\n  .monokai .grvsc-tsSx3w-6 { color: #E6DB74; }\n  .monokai .grvsc-tsSx3w-9 { color: #66D9EF; }\n  .monokai .grvsc-tsSx3w-4 { color: #AE81FF; }\n  .monokai .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n  .light .grvsc-ps-tsSx3w {\n    background-color: #272822;\n    color: #f8f8f2;\n  }\n  .light .grvsc-ps-tsSx3w .grvsc-tsSx3w-1 { color: #F8F8F2; }\n  .light .grvsc-ps-tsSx3w .grvsc-tsSx3w-6 { color: #E6DB74; }\n  .light .grvsc-ps-tsSx3w .grvsc-tsSx3w-9 { color: #66D9EF; }\n  .light .grvsc-ps-tsSx3w .grvsc-tsSx3w-4 { color: #AE81FF; }\n  .light .grvsc-ps-tsSx3w .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n  .solarized-light { background-color: #FDF6E3; }\n  .solarized-light .mtk1 { color: #657B83; }\n  .solarized-light .grvsc-tiaGIi-11 { color: #2AA198; }\n  .solarized-light .grvsc-tiaGIi-7 { color: #268BD2; }\n  .solarized-light .grvsc-tiaGIi-6 { color: #D33682; }\n  .solarized-light .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(0, 0, 0, 0.05));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(0, 0, 0, 0.2));\n  }\n  .dark .grvsc-ps-tiaGIi { background-color: #FDF6E3; }\n  .dark .grvsc-ps-tiaGIi .mtk1 { color: #657B83; }\n  .dark .grvsc-ps-tiaGIi .grvsc-tiaGIi-11 { color: #2AA198; }\n  .dark .grvsc-ps-tiaGIi .grvsc-tiaGIi-7 { color: #268BD2; }\n  .dark .grvsc-ps-tiaGIi .grvsc-tiaGIi-6 { color: #D33682; }\n  .dark .grvsc-ps-tiaGIi .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(0, 0, 0, 0.05));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(0, 0, 0, 0.2));\n  }\n  \n  /* Solarized Light */\n  @media (prefers-color-scheme: dark) {\n    .grvsc-mm-tiaGIi { background-color: #FDF6E3; }\n    .grvsc-mm-tiaGIi .mtk1 { color: #657B83; }\n    .grvsc-mm-tiaGIi .grvsc-tiaGIi-11 { color: #2AA198; }\n    .grvsc-mm-tiaGIi .grvsc-tiaGIi-7 { color: #268BD2; }\n    .grvsc-mm-tiaGIi .grvsc-tiaGIi-6 { color: #D33682; }\n    .grvsc-mm-tiaGIi .grvsc-line-highlighted::before {\n      background-color: var(--grvsc-line-highlighted-background-color, rgba(0, 0, 0, 0.05));\n      box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(0, 0, 0, 0.2));\n    }\n  }\n</style>","frontmatter":{"title":"Gatsby Plugins Versioning and Build Failure","preview":"Trouble shooting gatsby-plugin-postcss in Gatsby v2 and v3","date":"2021-04-02"},"timeToRead":2},"previous":null,"next":{"fields":{"slug":"/post/2021-04-10/react-frameworks-for-static-generation/"},"frontmatter":{"title":"React Frameworks for Static Generation"}}},"pageContext":{"slug":"/post/2021-04-02/gatsby-plugins-versioning-and-build-failure/","id":"b1165ba4-cc37-54fa-9357-426e49a64d4b","previousPostId":null,"nextPostId":"22141824-719e-51e0-a29c-df7b0d43f666"}},"staticQueryHashes":["634353619"]}